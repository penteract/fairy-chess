<!DOCTYPE html>

<html>
<head>
    <meta charset="utf-8">
    <title>Fairy Chess</title>
    <style>
td{
    text-align: center;
    width: 30px;
    height: 30px;
    padding: 0px;
}
tr:nth-child(even) td:nth-child(even), tr:nth-child(odd) td:nth-child(odd){
    background-color: burlywood;
}
tr:nth-child(odd) td:nth-child(even), tr:nth-child(even) td:nth-child(odd){
    background-color: goldenrod;
}
td.clicked{
    background-color: lime !important;
}
table{
    border-spacing: 10px;
}
    </style>
</head>
<body>
    <table id="board">
    </table>
    <div>To invite someone to join or spectate the game, share the url of this page</div>
    <div id="moveHistory"></div>
    <script>
const table = document.getElementById("board")
// receiving/displaying
test = `♜♞♝♛♚♝♞♜
♟♟♟♟♟♟♟♟
        
        ♔  
        
        
♙♙♙♙♙♙♙♙
♖♘♗♕♔♗♘♖`
function tagWith(list,tag){
    return `<${tag}>`+ list.join(`</${tag}><${tag}>`)+`</${tag}>`
}
function showBoard(b){
    b=b.split("\n").map(x=>x.split(""))
    table.innerHTML = "<tbody>"+tagWith( b.map(r=>tagWith(r,"td")) ,"tr")+"</tbody>"
}
showBoard(test)
function updateState(data){
    showBoard(data.substr(0,9*8-1))
    move = data.substr(9*8-1,4)
    if (move !="    "){
        moveHistory.innerHTML+= move[0]+(letters.indexOf(move[1])+1)+
          move[2]+(letters.indexOf(move[3])+1)+"<br />"
    }
    result = data.substr(9*8+3)
    if(result=="Continue")
    unsetClickedCell()
}

let conn = new WebSocket("ws://"+window.location.host+"/play"+window.location.search)
conn.onmessage = e => updateState(e.data)
conn.onopen = function(e) {
    console.log("open",e)
    sendMove = data => e.target.send(data)
    e.target.send(sec=randstr())
}
conn.onerror = e => console.log("error",e)
conn.onclose = e => console.log("close",e)

// sending/input handling
const letters = "ABCDEFGH"
function getPos(td){
    const tr = td.parentElement
    const file = Array(...tr.children).indexOf(td)
    const rank = 7-Array(...tr.parentElement.children).indexOf(tr)
    return letters[file]+letters[rank]
}

let clickedCell = null;
function setClicked(td){
    if(clickedCell!==null) throw "did not expect any cell to be selected"
    clickedCell=td
    clickedCell.classList.add("clicked")
}
function unsetClickedCell(){
    if (clickedCell!==null){
        clickedCell.classList.remove("clicked")
        clickedCell=null
    }
}

table.onclick = function (e){
    if(HTMLTableCellElement.prototype.isPrototypeOf(e.target)){
        if (clickedCell===null){
            setClicked(e.target)
        } else {
            sendMove(getPos(clickedCell)+getPos(e.target))

            unsetClickedCell()
        }
    } else {
        unsetClickedCell()
    }
}
function randstr() {
    s=""
    for(let i=0;i<10;i++) s+=String.fromCharCode(65+Math.random()*26)
    return s
}

</script>
</body>
</html>